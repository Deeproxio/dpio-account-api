name: Deeproxio.UserManagement.API-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  - "*"

pool: Development

variables:
- group: Local-Harbor-Registry
- name: buildConfiguration
  value: 'Release'
- name: ciImageTag
  value: 'ci-$(Build.BuildId)'
- name: helmRepositoryName
  value: 'dpio-user-management-api-chart'
- name: serviceImageName
  value: dpio-user-management-api
- name: migrationImageName
  value: dpio-user-management-api-db-migration
- name: releaseName
  value: user-management-api

stages:
  - stage: 'Build'
    displayName: 'Build API & Docker Images'
    jobs: 
    - job: 'Build'
      displayName: 'Build Deeproxio.UserManagement.API'
      pool: Development
      variables:
        dotnetSdkVersion: '3.1.x'
      steps:

      - task: UseDotNet@2
        displayName: 'Use .NET Core SDK $(dotnetSdkVersion)'
        inputs:
          version: '$(dotnetSdkVersion)'
          performMultiLevelLookup: true

      - task: DotNetCoreCLI@2
        displayName: 'Restore project dependencies'
        inputs:
          command: 'restore'
          projects: '**/*.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Build Deeproxio.UserManagement.API - $(buildConfiguration)'
        inputs:
          command: 'build'
          arguments: '--no-restore --configuration $(buildConfiguration)'
          projects: '**/Deeproxio.UserManagement.API.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Run Unit Tests'
        inputs:
          command: test
          projects: '**/*Tests/*.csproj'
          arguments: '--configuration Debug --collect "Code coverage"'

      - task: DotNetCoreCLI@2
        displayName: 'Publish Deeproxio.UserManagement.API - $(buildConfiguration)'
        inputs:
          command: 'publish'
          publishWebProjects: True
          arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)'
          projects: '**/Deeproxio.UserManagement.API.csproj'
          zipAfterPublish: True

      - script: >-
          docker build -f ./Deeproxio.UserManagement.API/Dockerfile
          -t $(harbor_endpoint)/$(serviceImageName):latest
          -t $(harbor_endpoint)/$(serviceImageName):$(ciImageTag) .
        displayName: 'docker build (API)'

      - script: >-
          docker build -f ./Deeproxio.Persistence.Identity.Migration/Dockerfile
          -t $(harbor_endpoint)/$(migrationImageName):latest
          -t $(harbor_endpoint)/$(migrationImageName):$(ciImageTag) .
        displayName: 'docker build (Migration Job)'

      - script: >-
          docker login
          -u $(harbor_username)
          -p $(harbor_password)
          $(harbor_endpoint)
        displayName: 'docker login (Local Harbor Registry)'

      - script: >-
          docker push $(harbor_endpoint)/$(serviceImageName):$(ciImageTag) &&
          docker push $(harbor_endpoint)/$(migrationImageName):latest
        displayName: 'docker push (API)'

      - script: >-
          docker push $(harbor_endpoint)/$(migrationImageName):$(ciImageTag) &&
          docker push $(harbor_endpoint)/$(migrationImageName):latest
        displayName: 'docker push (Migration Job)'

      - script: >-
          helm lint ./chart/$(serviceImageName)
          --debug
          --logtostderr
        displayName: 'Helm Chart static analysis'
      
      - script: >-
          helm package ./chart/$(serviceImageName)
          --logtostderr
          --dependency-update
          --app-version $(ciImageTag)
          --destination $(Build.ArtifactStagingDirectory)
        displayName: 'Helm Chart package build'

      - script: >-
          helm registry login
          -u $(harbor_username)
          -p $(harbor_password)
          $(harbor_endpoint)
        displayName: 'helm login (Local Harbor Registry)'

      - script: >-
          helm chart save
          ./chart/$(serviceImageName)
          $(harbor_endpoint)/$(helmRepositoryName):$(ciImageTag)
        displayName: 'Save Helm Chart to Local Harbor Registry'

      - script: >-
          helm chart push
          $(harbor_endpoint)/$(helmRepositoryName):$(ciImageTag)
        displayName: 'Push Helm Chart to Local Harbor Registry'

      - publish: '$(Build.ArtifactStagingDirectory)'
        displayName: 'Upload Build Artifacts'
        artifact: drop
  
  - stage: 'Local'
    displayName: 'Deploy to dpio-local environment'
    dependsOn: Build
    condition: succeeded()
    jobs:
    - deployment: Deploy
      pool: Development
      environment: dpio-local
      variables:
      - group: dpio-local-settings
      - group: dpio-platform-endpoint-paths
      strategy:
        runOnce:
          deploy:
            steps:

            - template: ci/stage-deployment.yml
              parameters:
                harbor_username: $(harbor_username)
                harbor_password: $(harbor_password)
                harbor_endpoint: $(harbor_endpoint)
                helmRepositoryName: $(helmRepositoryName)
                ciImageTag: $(ciImageTag)
                serviceImageName: $(serviceImageName)
                imagePullSecretName: $(imagePullSecretName)
                releaseName: $(releaseName)
                namespace: $(namespace)
                secretKey: $(secretKey)
                host: $(host)
                tokenServicePath: $(tokenServicePath)
                migrationImageName: $(migrationImageName)


  - stage: 'Staging'
    displayName: 'Deploy to dpio-staging environment'
    dependsOn: Local
    condition: |
      and
      (
        succeeded(),
        or
        (
          eq(variables['Build.SourceBranchName'], 'develop'),
          eq(variables['Build.SourceBranchName'], 'master')
        )
      )
    jobs:
    - deployment: Deploy
      pool: Development
      environment: dpio-staging
      variables:
      - group: dpio-staging-settings
      - group: dpio-platform-endpoint-paths
      strategy:
        runOnce:
          deploy:
            steps:

            - template: ci/stage-deployment.yml
              parameters:
                harbor_username: $(harbor_username)
                harbor_password: $(harbor_password)
                harbor_endpoint: $(harbor_endpoint)
                helmRepositoryName: $(helmRepositoryName)
                ciImageTag: $(ciImageTag)
                serviceImageName: $(serviceImageName)
                imagePullSecretName: $(imagePullSecretName)
                releaseName: $(releaseName)
                namespace: $(namespace)
                secretKey: $(secretKey)
                host: $(host)
                tokenServicePath: $(tokenServicePath)
                migrationImageName: $(migrationImageName)
